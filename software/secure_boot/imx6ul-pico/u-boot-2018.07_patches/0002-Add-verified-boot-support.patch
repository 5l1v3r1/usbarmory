From 18b9caf4649cf8498bec3250f9b0a7b609858a50 Mon Sep 17 00:00:00 2001
From: Andrej Rosano <andrej.rosano@f-secure.com>
Date: Mon, 27 Aug 2018 12:04:35 +0200
Subject: [PATCH] Add verified boot support

---
 configs/pico-imx6ul_defconfig | 10 +++++++++-
 include/configs/pico-imx6ul.h | 17 +++++------------
 2 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/configs/pico-imx6ul_defconfig b/configs/pico-imx6ul_defconfig
index 7a4c63e415..a416310ec4 100644
--- a/configs/pico-imx6ul_defconfig
+++ b/configs/pico-imx6ul_defconfig
@@ -28,7 +28,7 @@ CONFIG_CMD_EXT4=y
 CONFIG_CMD_EXT4_WRITE=y
 CONFIG_CMD_FAT=y
 CONFIG_CMD_FS_GENERIC=y
-CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_IS_NOWHERE=y
 CONFIG_DFU_MMC=y
 CONFIG_FSL_ESDHC=y
 CONFIG_PHYLIB=y
@@ -44,3 +44,11 @@ CONFIG_USB_GADGET_DOWNLOAD=y
 CONFIG_OF_LIBFDT=y
 
 CONFIG_SECURE_BOOT=y
+
+CONFIG_DM=y
+CONFIG_FIT=y
+CONFIG_OF_CONTROL=y
+CONFIG_OF_SEPARATE=y
+CONFIG_FIT_SIGNATURE=y
+CONFIG_RSA=y
+CONFIG_RSA_SOFTWARE_EXP=y
diff --git a/include/configs/pico-imx6ul.h b/include/configs/pico-imx6ul.h
index 038b0a4778..11346d2645 100644
--- a/include/configs/pico-imx6ul.h
+++ b/include/configs/pico-imx6ul.h
@@ -106,12 +102,9 @@
 		"fi;\0" \
 
 #define CONFIG_BOOTCOMMAND \
-	   "if mmc rescan; then " \
-		   "if run loadimage; then " \
-			   "run mmcboot; " \
-		   "else run netboot; " \
-		   "fi; " \
-	   "else run netboot; fi"
+	"setenv bootargs console=ttymxc5,115200; "		\
+	"ext2load mmc 0:1 ${loadaddr} pico.itb 0x4000000; "	\
+	"bootm ${loadaddr}"
 
 #define CONFIG_SYS_MEMTEST_START	0x80000000
 #define CONFIG_SYS_MEMTEST_END		CONFIG_SYS_MEMTEST_START + SZ_128M
-- 
2.19.1

